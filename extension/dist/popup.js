(()=>{function w(o){return o.replace(/\- \d+/,"").replace(/\(.+\)/,"").replace(/:.+$/,"")}function y(o,e){let a=o(e).find(".directory-Entry_Header"),n={},p=a.find(".directory-Entry_FieldValue");a.find(".directory-Entry_FieldLabel").each((m,b)=>{b.textContent&&(n[b.textContent.trim().toLowerCase()]=p[m].textContent?.trim())});let d={name:a.find(".directory-Entry_Title")[0].textContent?.trim()??"",photo:a.find(".directory-Entry_PersonPhoto--full")[0].getAttribute("src")??"",contact:{email:"",...n},households:[],grade:a.find(".directory-Entry_Tag")[0].innerHTML.replace("Grade","").trim()};return o(e).find(".directory-Entry_HouseholdSection").each((m,b)=>{let r,t=o(b).find(".directory-Entry_FieldTitle .directory-Entry_GoogleMapsLinkIcon")[0]?.parentElement;t!=null&&(r={text:t?.parentElement?.textContent?.trim(),url:t?.getAttribute("href")});let i=[];o(b).find(".directory-Entry_FieldTitle--blue").each((s,c)=>{let g=o(c.parentElement?.parentElement),f=g.find(".directory-Entry_FieldValue"),h={name:c.textContent?.trim()};g.find(".directory-Entry_FieldLabel").each((A,x)=>{x.textContent&&(h[x.textContent.trim().toLowerCase()]=f[A].textContent?.trim())}),i.push(h)}),d.households.push({parents:i,address:r})}),d}async function G(){try{return(await chrome.cookies.get({name:"_veracross_session",url:"https://portals.veracross.com/"})).value}catch(o){return`Unexpected error: ${o.message}`}}async function k(o){let e=await fetch(o,{headers:{cookie:"_veracross_session="+G()},redirect:"manual",window:null});return e.ok?(await e.text()).replace(/<script>?[\S\s]+?<\/script>/mg,""):void 0}async function z(o){let e=await k(`https://portals.veracross.com/${o}/student/student/overview`);return e==null,null}function B(o){let e=$("#grid");e.empty();let a=$('<div class="grid-row"><div class="grid-item" onclick="sortGridByName()"></div></div>');o.classes.forEach((r,t)=>{a.append(`<div class="grid-item" id="class-${r}">${j(r)}</div>`)}),e.append(a),o.classes.forEach((r,t)=>{document.getElementById(`class-${r}`)?.addEventListener("click",()=>m(r))});for(let[r,t]of Object.entries(o.students).sort((i,s)=>i[0]?.localeCompare(s[0]))){let i=$(`<div class="grid-row" name="${r}"></div>`);i.append(`<div class="grid-item">${r}</div>`);let s=!1;o.classes.forEach((c,g)=>{t.includes(c)?(s=!0,i.append(`<div class="grid-item" title="${r} - ${j(c)}">\u2714</div>`)):i.append('<div class="grid-item"></div>')}),s&&e.append(i)}let n=null,p=(r,t)=>(l(n,r,!1),l(n,t,!1),r.getAttribute("name").localeCompare(t.getAttribute("name")));function d(){b(r=>{r.sort(p),n=null})}function l(r,t,i){r&&(i?(t.classList.add("highlight-included"),t.children[o.classes.indexOf(r)+1].classList.add("highlight-column")):(t.classList.remove("highlight-included"),t.children[o.classes.indexOf(r)+1].classList.remove("highlight-column")))}function m(r){r!=n&&($("#grid").children().get(0).children[o.classes.indexOf(r)+1].classList.add("highlight-column"),b(t=>{let i=s=>o.students[s]?.includes(r);t.sort(p).sort((s,c)=>{let g=i(s.getAttribute("name")),f=i(c.getAttribute("name"));return l(r,s,g),l(r,c,f),g==f?0:g&&!f?-1:1}),n=r}))}function b(r){n&&$("#grid").children().get(0).children[o.classes.indexOf(n)+1].classList.remove("highlight-column"),$("#grid").scrollLeft(0);let t=$("#grid").children(),i=t.slice(1);r(i),$("#grid").get(0).replaceChildren(t[0],...i)}globalThis.sortGridByClass=m,globalThis.sortGridByName=d,a.parent().css("--grid-columns",o.classes.length)}function j(o){return o.replace(/\- \d+/,"").replace(/\(.+\)/,"").replace(/:.+$/,"")}var u=document.getElementById("message"),E=document.getElementById("updatebutton"),v=document.getElementById("schoolname"),R=o=>new Promise((e,a)=>chrome.storage.sync.get(o,n=>chrome.runtime.lastError?a(Error(chrome.runtime.lastError.message)):e(n)));function L(o){return new Promise((e,a)=>chrome.storage.sync.set(o,()=>chrome.runtime.lastError?a(Error(chrome.runtime.lastError.message)):e()))}(async()=>{v.value=(await R("schoolname")).schoolname??"catlin",o(),E.addEventListener("click",()=>{o()}),v.addEventListener("change",()=>{L({schoolname:v.value})});async function o(){u.hidden=!0;let e=await z(v.value);if(e==null){u.hidden=!1,u.textContent="Please sign into Veracross",$("#grid").empty();return}try{let a={};Object.entries(e).forEach(([p,d])=>{for(let l of d)a[l]=!0});let n={classes:Object.keys(a).sort(),students:e};B(n)}catch(a){console.error(a)}}})();})();
